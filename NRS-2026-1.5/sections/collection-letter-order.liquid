{% comment %} Collection Letter Order Section - Collection Pages Version {% endcomment %}
{% comment %} Matches master source exactly - single collection version {% endcomment %}

{%- comment %} Collection type detection: URL parameter FIRST, then handle {% endcomment -%}
{%- assign order_type = nil -%}

{%- comment %} FIRST: Check URL parameter ?type= (takes priority) {% endcomment -%}
{%- assign query_lower = request.query_string | downcase -%}
{%- if query_lower contains 'type=set' -%}
  {%- assign order_type = 'set' -%}
{%- elsif query_lower contains 'type=indv' -%}
  {%- assign order_type = 'indv' -%}
{%- endif -%}

{%- comment %} SECOND: Check handle if no URL param found {% endcomment -%}
{%- if order_type == nil -%}
  {%- if collection.handle contains '-set' -%}
    {%- assign order_type = 'set' -%}
  {%- elsif collection.handle contains '-indv' -%}
    {%- assign order_type = 'indv' -%}
  {%- endif -%}
{%- endif -%}

{%- comment %} Set show_section flag based on detection {% endcomment -%}
{%- if order_type == nil -%}
  {%- assign show_section = false -%}
{%- else -%}
  {%- assign show_section = true -%}
{%- endif -%}

{%- if show_section -%}
  {%- comment %} Load shared CSS and JS {% endcomment -%}
  {{ 'letter-master-order.css' | asset_url | stylesheet_tag }}
  {{ 'letter-master-order.js' | asset_url | script_tag }}

  {%- comment %} Build masterCollectionsData structure (Q2: Option B - match master exactly) {% endcomment -%}
  <script>var masterCollectionsData = {};</script>

  {%- assign source_collection = collection -%}
  {%- if source_collection != blank -%}
    {%- assign parent_handle = collection.handle | remove: "-indv" | remove: "-set" -%}
    {%- assign parent_collection = collections[parent_handle] -%}

    {%- comment %} Consolidated description splitting (same as master) {% endcomment -%}
    {%- assign desc_source = '' -%}
    {%- if collection.handle contains "-indv" -%}
      {%- assign desc_source = source_collection.description -%}
    {%- else -%}
      {%- assign desc_source = parent_collection.description | default: source_collection.description -%}
    {%- endif -%}
    {%- assign desc_parts = desc_source | split: '<div id="content-details">' -%}
    {%- assign main_desc = desc_parts[0] | default: '' -%}
    {%- assign details_desc = '' -%}
    {%- assign specs_desc = '' -%}
    {%- if desc_parts[1] -%}
      {%- assign details_parts = desc_parts[1] | split: '<div id="content-specs">' -%}
      {%- assign details_desc = details_parts[0] | default: '' -%}
      {%- assign specs_desc = details_parts[1] | default: '' -%}
    {%- endif -%}

    {%- if details_desc != blank -%}
      {%- assign has_details = true -%}
    {%- else -%}
      {%- assign has_details = false -%}
    {%- endif -%}
    {%- if specs_desc != blank -%}
      {%- assign has_specs = true -%}
    {%- else -%}
      {%- assign has_specs = false -%}
    {%- endif -%}

    {%- comment %} Image and title {% endcomment -%}
    {%- assign image_src = '' -%}
    {%- if parent_collection != blank and parent_collection.image -%}
      {%- assign image_src = parent_collection.image.src | image_url: width: 600, height: 600 -%}
    {%- elsif source_collection.image -%}
      {%- assign image_src = source_collection.image.src | image_url: width: 600, height: 600 -%}
    {%- endif -%}
    {%- assign display_title = parent_collection.title | default: source_collection.title -%}

    {%- comment %} Availability {% endcomment -%}
    {%- assign products_available = false -%}
    {%- assign first_product = source_collection.products.first -%}
    {%- if first_product != blank -%}
      {%- assign first_variant = first_product.variants.first -%}
      {%- if first_variant != blank and first_variant.available -%}
        {%- assign products_available = true -%}
      {%- endif -%}
    {%- endif -%}

    {%- comment %} Build data matching master structure exactly (source lines 64-81) {% endcomment -%}
    <script>
      masterCollectionsData[{{ collection.handle | json }}] = {
        handle: {{ collection.handle | json }},
        parent_handle: {{ parent_handle | json }},
        title: {{ display_title | json }},
        image: {{ image_src | json }},
        description: {{ main_desc | json }},
        details: {{ details_desc | prepend: '<div id="content-details">' | json }},
        specs: {{ specs_desc | prepend: '<div id="content-specs">' | json }},
        has_details: {{ has_details | json }},
        has_specs: {{ has_specs | json }},
        products_available: {{ products_available | json }},
        height_obj: {},
        variant_obj: {},
        price_obj: {},
        height_color_obj: {},
        color_set_obj: {}
      };
    </script>

    {%- comment %} Build variant data (same as master, but for single collection) {% endcomment -%}
    {%- paginate source_collection.products by 200 -%}
      {%- for product_item in source_collection.products -%}
        {%- assign product_variants = product_item.variants -%}

        {%- if order_type == 'indv' -%}
          {%- assign letter_name = product_item.title | split: " - " | last -%}
          {%- assign letter_clean = letter_name | handleize -%}
          {%- assign letter_str = "letter-" | append: letter_clean -%}
        {%- endif -%}

        <script>
          (function(){
            var variants_obj = {{ product_variants | json }};
            var data = masterCollectionsData[{{ collection.handle | json }}];
            var isIndv = {{ collection.handle | json }}.includes("-indv");
            for (var k in variants_obj) {
              if (!variants_obj.hasOwnProperty(k)) continue;
              var variant = variants_obj[k];
              var height = variant.option1 || "";
              if (isIndv) {
                var color = variant.option2 || "";
                var letterStr = {{ letter_str | json }};
                var height_color = height + "||" + color;
                if (!data.height_obj[height]) { data.height_obj[height] = []; }
                if (data.height_obj[height].indexOf(color) === -1) { data.height_obj[height].push(color); }
                if (!data.height_color_obj[height_color]) { data.height_color_obj[height_color] = []; }
                if (data.height_color_obj[height_color].indexOf(letterStr) === -1) { data.height_color_obj[height_color].push(letterStr); }
                var full_key = height_color + "||" + letterStr;
                data.variant_obj[full_key] = variant.id;
                data.price_obj[full_key] = (variant.price / 100);
              } else {
                var setType = variant.option2 || "";
                var color = variant.option3 || "";
                var height_color = height + "||" + color;
                if (!data.height_obj[height]) { data.height_obj[height] = []; }
                if (data.height_obj[height].indexOf(color) === -1) { data.height_obj[height].push(color); }
                if (!data.color_set_obj[height_color]) { data.color_set_obj[height_color] = []; }
                data.color_set_obj[height_color].push({
                  title: setType,
                  id: variant.id,
                  price: (variant.price / 100),
                  available: variant.available
                });
              }
            }
          })();
        </script>
      {%- endfor -%}
    {%- endpaginate -%}

    {%- comment %} Signal that data building is complete {% endcomment -%}
    <script>
      if (window.masterCollectionsData && window.masterCollectionsData[{{ collection.handle | json }}]) {
        window.masterCollectionsData[{{ collection.handle | json }}]._dataReady = true;
        console.log('Collection data ready:', window.masterCollectionsData[{{ collection.handle | json }}]);
      }
    </script>
  {%- endif -%}

  {%- comment %} Match master structure exactly (Q4: Option B) - tabs/selectors hidden via CSS {% endcomment -%}
  <div class="page-order-page-master collection-mode">

    {%- comment %} Top-level tabs (will be hidden via CSS) {% endcomment -%}
    <div class="tabs-nav-form-master top-level-tabs">
      <div class="tab-link-master {% if order_type == 'indv' %}active{% endif %}" data-tab-name="indv">INDIVIDUAL LETTERS</div>
      <div class="tab-link-master {% if order_type == 'set' %}active{% endif %}" data-tab-name="set">LETTER SETS</div>
    </div>

    {%- comment %} Tab Content: Individual Letters {% endcomment -%}
    <div id="tab-content-indv" class="tab-content-master {% if order_type == 'indv' %}active{% endif %}">
      <div class="master-tab-inner-content">

        {%- comment %} Collection selector (will be hidden via CSS) {% endcomment -%}
        <div class="collection-selector-wrapper-master">
          <h2 class="selector-main-title-master">Select a style/collection:</h2>
          <div class="selector-divider-master"></div>
          <div class="collection-selector-grid-master collection-selector-grid-indv">
            {%- comment %} Empty - no selector needed for collection page {% endcomment -%}
          </div>
          <div class="selector-divider-master"></div>
        </div>

        {%- comment %} Main layout grid {% endcomment -%}
        <div class="grid-12-master">
          {%- render 'letter-form-indv', collection_handle: collection.handle, order_type: order_type -%}
          {%- render 'letter-description', collection_handle: collection.handle, order_type: order_type -%}
        </div>
      </div>
    </div>

    {%- comment %} Tab Content: Letter Sets {% endcomment -%}
    <div id="tab-content-set" class="tab-content-master {% if order_type == 'set' %}active{% endif %}">
      <div class="master-tab-inner-content">

        {%- comment %} Collection selector (will be hidden via CSS) {% endcomment -%}
        <div class="collection-selector-wrapper-master">
          <h2 class="selector-main-title-master">Select a style/collection:</h2>
          <div class="selector-divider-master"></div>
          <div class="collection-selector-grid-master collection-selector-grid-set">
            {%- comment %} Empty - no selector needed for collection page {% endcomment -%}
          </div>
          <div class="selector-divider-master"></div>
        </div>

        {%- comment %} Main layout grid {% endcomment -%}
        <div class="grid-12-master">
          {%- render 'letter-form-set', collection_handle: collection.handle, order_type: order_type -%}
          {%- render 'letter-description', collection_handle: collection.handle, order_type: order_type -%}
        </div>
      </div>
    </div>

  </div>
{%- endif -%}

{% comment %} Note: Add this section manually to collection.json via theme customizer {% endcomment %}
{% schema %}
{
  "name": "Collection Letter Order",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Add this section to collection templates via the theme customizer. It will auto-detect letter type from URL/handle."
    }
  ],
  "presets": [
    {
      "name": "Collection Letter Order"
    }
  ]
}
{% endschema %}
