{% comment %}
  Snippet for letter ordering form, replicating old functionality from letters-indv-with-disclaimer.liquid.
  Uses include.source_collection if provided (for page template), otherwise falls back to collection.handle -indv (for collection template).
  Assumes -indv collection has products with titles like "Letter - A", "Number - 0", "Symbol - $"
  and variants with option1 (height) and option2 (color).
{% endcomment %}

{% if include.source_collection %}
  {% assign letters_collection = include.source_collection %}
  <p>Debug: Using page-selected collection: {{ letters_collection.handle }}</p>
{% else %}
  {% assign letters_collection_handle = collection.handle | append: "-indv" %}
  {% assign letters_collection = collections[letters_collection_handle] %}
  <p>Debug: Using default collection: {{ letters_collection_handle }}</p>
{% endif %}

<div class="letters-order-form">
  <script>
    console.log("Letters collection handle: {{ letters_collection.handle }}");
    {% paginate letters_collection.products by 200 %}
      var height_obj = {};
      var height_color_obj = {};
      var variant_obj = {};
      var price_obj = {};

      {% for letter in letters_collection.products %}
        console.log("Processing product: {{ letter.title }}");
        var variants_obj = {{ letter.variants | json }};

        for (var key in variants_obj) {
          var variant = variants_obj[key];
          var height = variant.option1;
          var color = variant.option2;
          var height_color = height + "||" + color;

          {% assign letter_arr = letter.title | split: " - " %}
          {% assign letter_name = letter_arr | last %}
          {% assign letter_clean = letter_name | handleize %}
          {% assign letter_str = "letter-" | append: letter_clean %}
          console.log("Variant - Height: " + height + ", Color: " + color + ", Letter: " + letter_str);

          if (!height_obj[height]) {
            height_obj[height] = [];
          }
          if (height_obj[height].indexOf(color) === -1) {
            height_obj[height].push(color);
          }

          if (!height_color_obj[height_color]) {
            height_color_obj[height_color] = [];
          }
          if (height_color_obj[height_color].indexOf("{{ letter_str }}") === -1) {
            height_color_obj[height_color].push("{{ letter_str }}");
          }

          var full_key = height_color + "||" + "{{ letter_str }}";
          variant_obj[full_key] = variant.id;
          price_obj[full_key] = variant.price / 100;
        }
      {% endfor %}
      console.log("Height obj: ", height_obj);
      console.log("Height-color obj: ", height_color_obj);
    {% endpaginate %}
  </script>

  <form name="lettersForm" class="letters-form">
    <h3>Ordering letters in 3 easy steps</h3>

    <div class="step first-step">
      <div class="left-col">
        <span class="no">1</span>
        <p class="label">Choose Your Letter / Panel Height</p>
        <div class="letter-height">
          <div class="left">
            <img 
              src="//cdn.shopify.com/s/files/1/0284/0298/t/2/assets/howto.gif?4990" 
              alt="How to find your Panel Height"
              width="350"
              height="263"
              style="max-width:100%; height:auto;">
          </div>
          <div class="right">
            <h3>How to Find Your Letter / Panel Height</h3>
            <p>The Letter Height is the measurement of the letter by itself.<br><br>The Panel Height is the measurement of the entire plastic panel.</p>
          </div>
        </div>
      </div>
      <div class="right-col">
        <select name="letter-height" id="letter-height">
          <option value="">Select Height</option>
        </select>
      </div>
    </div>

    <div class="step">
      <div class="left-col">
        <span class="no">2</span>
        <p class="label">Choose Your Color</p>
      </div>
      <div class="right-col">
        <select name="letter-color" id="letter-color">
          <option value="">Select Color</option>
        </select>
      </div>
    </div>

    <div class="step">
      <div class="left-col">
        <span class="no">3</span>
        <p class="label">Choose Your Letters and Quantity</p>
      </div>
    </div>
    <p>First choose a color above to see which characters are available.<br>Then below each letter, enter the quantity you would like to order.</p>
    <p style="color:#f00;"> NOTE: the letters I and O and the numbers вЂ1вЂ™ and zero are visually identical in the ADM Standard and Modern letter styles</p>

    <div class="letters">
      {% assign uppercase_letters = 'A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z' | split: ',' %}
      <div class="letter-row">
        {% for char in uppercase_letters %}
          <div class="letter" style="display: none;">
            <div class="letter-sku">{{ char }}</div>
            <label for="letter-{{ char | downcase }}">{{ char }}</label>
            <input type="text" name="letter-{{ char | downcase }}" value="" id="letter-{{ char | downcase }}">
          </div>
        {% endfor %}
      </div>

      <div class="letter-row">
        {% for num in (0..9) %}
          <div class="letter" style="display: none;">
            <div class="letter-sku">{{ num }}</div>
            <label for="letter-{{ num }}">{{ num }}</label>
            <input type="text" name="letter-{{ num }}" value="" id="letter-{{ num }}">
          </div>
        {% endfor %}
      </div>

      <div class="letter-row">
        <div class="letter" style="display: none;">
          <div class="letter-sku">Вў</div>
          <label for="letter-cent-sign">Вў</label>
          <input type="text" name="letter-cent-sign" value="" id="letter-cent-sign">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">$</div>
          <label for="letter-dollar-sign">$</label>
          <input type="text" name="letter-dollar-sign" value="" id="letter-dollar-sign">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">.</div>
          <label for="letter-period">.</label>
          <input type="text" name="letter-period" value="" id="letter-period">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">&</div>
          <label for="letter-ampersand">&</label>
          <input type="text" name="letter-ampersand" value="" id="letter-ampersand">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">!</div>
          <label for="letter-exclamation">!</label>
          <input type="text" name="letter-exclamation" value="" id="letter-exclamation">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">?</div>
          <label for="letter-question">?</label>
          <input type="text" name="letter-question" value="" id="letter-question">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">вЂ</div>
          <label for="letter-apostrophe">вЂ</label>
          <input type="text" name="letter-apostrophe" value="" id="letter-apostrophe">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">,</div>
          <label for="letter-comma">,</label>
          <input type="text" name="letter-comma" value="" id="letter-comma">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">;</div>
          <label for="letter-semicolon">;</label>
          <input type="text" name="letter-semicolon" value="" id="letter-semicolon">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">:</div>
          <label for="letter-colon">:</label>
          <input type="text" name="letter-colon" value="" id="letter-colon">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">вЂњ</div>
          <label for="letter-left-quotation">вЂњ</label>
          <input type="text" name="letter-left-quotation" value="" id="letter-left-quotation">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">вЂќ</div>
          <label for="letter-right-quotation">вЂќ</label>
          <input type="text" name="letter-right-quotation" value="" id="letter-right-quotation">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">/</div>
          <label for="letter-slash">/</label>
          <input type="text" name="letter-slash" value="" id="letter-slash">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">-</div>
          <label for="letter-dash">-</label>
          <input type="text" name="letter-dash" value="" id="letter-dash">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">+</div>
          <label for="letter-plus-sign">+</label>
          <input type="text" name="letter-plus-sign" value="" id="letter-plus-sign">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">#</div>
          <label for="letter-pound-sign">#</label>
          <input type="text" name="letter-pound-sign" value="" id="letter-pound-sign">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">%</div>
          <label for="letter-percent-sign">%</label>
          <input type="text" name="letter-percent-sign" value="" id="letter-percent-sign">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">(</div>
          <label for="letter-left-parenthesis">(</label>
          <input type="text" name="letter-left-parenthesis" value="" id="letter-left-parenthesis">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">)</div>
          <label for="letter-right-parenthesis">)</label>
          <input type="text" name="letter-right-parenthesis" value="" id="letter-right-parenthesis">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">*</div>
          <label for="letter-asterisk">*</label>
          <input type="text" name="letter-asterisk" value="" id="letter-asterisk">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">Вј</div>
          <label for="letter-one-quarter">Вј</label>
          <input type="text" name="letter-one-quarter" value="" id="letter-one-quarter">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">в…“</div>
          <label for="letter-one-third">в…“</label>
          <input type="text" name="letter-one-third" value="" id="letter-one-third">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">ВЅ</div>
          <label for="letter-one-half">ВЅ</label>
          <input type="text" name="letter-one-half" value="" id="letter-one-half">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">Вѕ</div>
          <label for="letter-three-quarters">Вѕ</label>
          <input type="text" name="letter-three-quarters" value="" id="letter-three-quarters">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">9/10</div>
          <label for="letter-nine-tenths" class="small-letter">9/10</label>
          <input type="text" name="letter-nine-tenths" value="" id="letter-nine-tenths">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">@</div>
          <label for="letter-at-symbol">@</label>
          <input type="text" name="letter-at-symbol" value="" id="letter-at-symbol">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">STAR</div>
          <label for="letter-star" class="small-letter">STAR</label>
          <input type="text" name="letter-star" value="" id="letter-star">
        </div>
        <div class="letter" style="display: none;">
          <div class="letter-sku">=</div>
          <label for="letter-equals-symbol">=</label>
          <input type="text" name="letter-equals-symbol" value="" id="letter-equals-symbol">
        </div>
      </div>
    </div>

    <div class="price">$0.00</div>

    {% unless letters_collection.products.first.variants.first.available %}
      <input type="button" value="Sold Out" id="sold_out" disabled/>
    {% else %}
      <input id="add" type="submit" value="Add to Cart"/>
    {% endunless %}
    <br/>
    <span id="chars-error" style="display:none; color:red;">Please Indicate Characters</span>
    <span id="color-error" style="display:none; color:red;">Please Choose a Color</span>
  </form>

  <script>
    $(document).ready(function() {
      // Sort heights numerically by extracting the number before "вЂќ
      var heights = Object.keys(height_obj).sort(function(a, b) {
        var numA = parseInt(a.replace('вЂќ', ''));
        var numB = parseInt(b.replace('вЂќ', ''));
        return numA - numB;
      });
      var heightSelect = $('#letter-height');
      heights.forEach(function(height) {
        heightSelect.append('<option value="' + height + '">' + height + '</option>');
      });

      heightSelect.change(function() {
        var height = $(this).val();
        var colorSelect = $('#letter-color');
        colorSelect.html('<option value="">Select Color</option>');
        if (height) {
          height_obj[height].sort().forEach(function(color) {
            colorSelect.append('<option value="' + color + '">' + color + '</option>');
          });
        }
        updateCharacters();
        updatePrice();
      });

      $('#letter-color').change(function() {
        updateCharacters();
        updatePrice();
      });

      $('.letters input').on('input', function() {
        updatePrice();
      });

      function updateCharacters() {
        var height = $('#letter-height').val();
        var color = $('#letter-color').val();
        $('.letter').hide();
        if (height && color) {
          var key = height + "||" + color;
          var avail = height_color_obj[key] || [];
          avail.forEach(function(letterStr) {
            $('input[name="' + letterStr + '"]').closest('.letter').show();
          });
        }
      }

      function updatePrice() {
        var height = $('#letter-height').val();
        var color = $('#letter-color').val();
        var total = 0;
        if (height && color) {
          var baseKey = height + "||" + color + "||";
          $('.letters input:visible').each(function() {
            var qty = parseInt($(this).val()) || 0;
            if (qty > 0) {
              var letterStr = $(this).attr('name');
              var fullKey = baseKey + letterStr;
              var price = price_obj[fullKey] || 0;
              total += qty * price;
            }
          });
        }
        $('.price').text('$' + total.toFixed(2));
      }

      $('.letters-form').submit(function(e) {
        e.preventDefault();
        $('#chars-error, #color-error').hide();
        var height = $('#letter-height').val();
        var color = $('#letter-color').val();
        if (!height || !color) {
          $('#color-error').show();
          return;
        }
        var items = [];
        var hasItems = false;
        var baseKey = height + "||" + color + "||";
        $('.letters input:visible').each(function() {
          var qty = parseInt($(this).val()) || 0;
          if (qty > 0) {
            hasItems = true;
            var letterStr = $(this).attr('name');
            var fullKey = baseKey + letterStr;
            var variantId = variant_obj[fullKey];
            if (variantId) {
              items.push({ id: variantId, quantity: qty });
            }
          }
        });
        if (!hasItems) {
          $('#chars-error').show();
          return;
        }
        $.post('/cart/add.js', { items: items })
          .done(function() {
            window.location = '/cart';
          })
          .fail(function() {
            alert('Error adding items to cart. Please try again.');
          });
      });
    });
  </script>
</div>
