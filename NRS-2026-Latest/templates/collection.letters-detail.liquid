{% assign test_indv = collection.handle | append: "-indv" %}
{% assign test_set = collection.handle | append: "-set" %}
{% assign characters = "A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,0,1,2,3,4,5,6,7,8,9,¢,$,.,&,!,?,',/,:,-,%,*,#,+,(,),½,¼,⅓,¾,9/10,@,star,=" | split: ',' %}
{% assign sets_pricing = '{"4 inch": {"250pc": {"original": 400, "discounted": 320}, "100pc": {"original": 177, "discounted": 141.60}, "40pc_number": {"original": 70.80, "discounted": 56.64}, "20pc_punct": {"original": 35.40, "discounted": 28.32}}, "6 inch": {"250pc": {"original": 547.50, "discounted": 438}, "100pc": {"original": 245, "discounted": 196}, "40pc_number": {"original": 98, "discounted": 78.40}, "20pc_punct": {"original": 49, "discounted": 39.20}}, "8 inch": {"250pc": {"original": 817.50, "discounted": 654}, "100pc": {"original": 374, "discounted": 299.20}, "40pc_number": {"original": 149.60, "discounted": 119.68}, "20pc_punct": {"original": 74.80, "discounted": 59.84}}, "8 inch on 10 inch": {"250pc": {"original": 850, "discounted": 680}, "100pc": {"original": 392, "discounted": 313.60}, "40pc_number": {"original": 156.80, "discounted": 125.44}, "20pc_punct": {"original": 78.40, "discounted": 62.72}}, "10 inch": {"250pc": {"original": 1142, "discounted": 914}, "100pc": {"original": 530, "discounted": 424}, "40pc_number": {"original": 212, "discounted": 169.60}, "20pc_punct": {"original": 106, "discounted": 84.80}}}' | parse_json %}
{% assign howto_image = 'howto.gif' | file_img_url: '300x' %}

{% comment %} Debug: Output collection handles to check accessibility {% endcomment %}
{% if collections[test_indv].products.size == 0 %}
  <p class="debug-error halo-text text-red-500">Error: No products found in {{ test_indv }}. Check if the sub-collection exists and is published.</p>
{% endif %}
{% if collections[test_set] == blank %}
  <p class="debug-error halo-text text-red-500">Error: {{ test_set }} sub-collection not found.</p>
{% endif %}

{% comment %} Main content container, relying on theme's header, footer, and sidebar {% endcomment %}
<div class="container letters-collection-detail halo-section padding-top-30 padding-bottom-30">
  <!-- Order Form for Individual Letters -->
  {% if collections[test_indv].products.size > 0 %}
    <div class="halo-card">
      <h2 class="halo-block-title">Order Individual Letters</h2>
      <form id="gemini-pronto-form" method="post" action="/cart/add">
        <!-- Hidden input for collection handle -->
        <input type="hidden" id="collection-handle" value="{{ test_indv }}">

        <!-- Step 1: Size Selection -->
        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h3 class="halo-card-title">1. Choose Your Letter/Panel Height</h3>
            {% if howto_image %}
              <img src="{{ howto_image }}" alt="How to find your Panel Height" class="mb-4">
              <p class="halo-text">The Letter Height is the measurement of the letter by itself. The Panel Height is the measurement of the entire plastic panel.</p>
            {% endif %}
          </div>
          <div>
            <select name="size" id="size-selector" class="halo-select" required>
              <option value="" disabled selected>Select Size</option>
              <!-- Populated dynamically by JavaScript -->
            </select>
          </div>
        </div>

        <!-- Step 2: Color Selection -->
        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h3 class="halo-card-title">2. Choose Your Color</h3>
            <p class="halo-text">Select a color to see available characters.</p>
          </div>
          <div>
            <select name="color" id="color-selector" class="halo-select" required>
              <option value="" disabled selected>Select Color</option>
              <!-- Populated dynamically by JavaScript -->
            </select>
          </div>
        </div>

        <!-- Step 3: Letter/Number/Punctuation Quantities -->
        <div class="mb-6">
          <h3 class="halo-card-title">3. Choose Your Letters and Quantity</h3>
          <p class="halo-text mb-4">Note: The letter I and number 1 are visually identical.</p>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 letters">
            {% for char in characters %}
              {% assign char_id = char | handleize %}
              <div class="letter flex items-center">
                <label for="letter-{{ char_id }}" class="w-8 text-center">{{ char }}</label>
                <input type="number" id="letter-{{ char_id }}" name="properties[Character: {{ char }}]" class="halo-input w-full" min="0" value="0" placeholder="Qty">
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- Price Display -->
        <div class="price text-center mb-4">$0.00</div>

        <!-- Add to Cart Button -->
        <div class="text-center">
          {% if collections[test_indv].products.size == 0 %}
            <button type="button" class="btn btn--primary" disabled>Sold Out</button>
          {% else %}
            <button type="submit" class="btn btn--primary" id="add-to-cart-btn">Add to Cart</button>
          {% endif %}
          <div class="mt-2">
            <span id="chars-error" class="halo-text text-red-500 hidden">Please Indicate Characters</span>
            <span id="color-error" class="halo-text text-red-500 hidden">Please Choose a Color</span>
            <span id="minimum-error" class="halo-text text-red-500 hidden">12" letters require a minimum order of 15 pieces.</span>
          </div>
        </div>
      </form>
    </div>
  {% endif %}

  <!-- Pricing Table -->
  <h2 class="halo-block-title mt-8">Pricing Overview</h2>
  <div class="overflow-x-auto">
    <table class="halo-table">
      <thead>
        <tr>
          <th>Size</th>
          <th>Price per Letter</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody id="pricing-table-body">
        <!-- Populated dynamically by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Sets Pricing Table -->
  {% if sets_pricing.size > 0 %}
    <h2 class="halo-block-title mt-8">Letter Set Pricing (25% Off + Free Shipping)</h2>
    <p class="halo-text mb-4">Does not apply to Flex Letter Sets. Free shipping within the contiguous U.S. only.</p>
    <div class="overflow-x-auto">
      <table class="halo-table">
        <thead>
          <tr>
            <th>Size</th>
            <th>250-Piece Set</th>
            <th>100-Piece Set</th>
            <th>40-Piece Number</th>
            <th>20-Piece Punctuation</th>
          </tr>
        </thead>
        <tbody id="sets-pricing-table-body">
          <!-- Populated dynamically by JavaScript -->
        </tbody>
      </table>
    </div>
  {% endif %}

  <!-- Sets Link -->
  {% if collections[test_set] %}
    <div class="mt-8 text-center">
      <h2 class="halo-block-title">Explore Letter Sets</h2>
      <p class="halo-text mb-4">Save 25% and get free shipping on full sets!</p>
      <a href="{{ collections[test_set].url }}" class="btn btn--primary">View Full Letter Set Options</a>
    </div>
  {% endif %}
</div>

<style>
  .letters-collection-detail {
    font-family: var(--font-body-family);
  }
  .halo-block-title {
    font-size: var(--font-heading-size-h3);
    font-weight: var(--font-heading-weight);
    margin-bottom: 1.5rem;
  }
  .halo-card {
    border: 1px solid var(--color-border);
    padding: 1.5rem;
    border-radius: var(--border-radius);
  }
  .halo-card-title {
    font-size: var(--font-heading-size-h4);
    font-weight: var(--font-heading-weight);
    margin-bottom: 0.5rem;
  }
  .halo-select, .halo-input {
    border: 1px solid var(--color-border);
    padding: 0.5rem;
    border-radius: var(--border-radius);
    width: 100%;
  }
  .halo-table {
    width: 100%;
    border-collapse: collapse;
  }
  .halo-table th, .halo-table td {
    border: 1px solid var(--color-border);
    padding: 0.75rem;
    text-align: center;
  }
  .btn {
    padding: 0.75rem 1.5rem;
    border-radius: var(--border-radius);
    text-decoration: none;
  }
  .btn--primary {
    background-color: var(--color-button-background);
    color: var(--color-button-text);
  }
  .price {
    font-size: 1.25rem;
    font-weight: bold;
    color: var(--color-text);
  }
  .letters .letter {
    display: none;
  }
  .letters .letter.active {
    display: flex;
  }
  .debug-error {
    margin-bottom: 1rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize elements
    const sizeSelector = document.getElementById('size-selector');
    const colorSelector = document.getElementById('color-selector');
    const form = document.getElementById('gemini-pronto-form');
    const priceDisplay = document.querySelector('.price');
    const charsError = document.getElementById('chars-error');
    const colorError = document.getElementById('color-error');
    const minimumError = document.getElementById('minimum-error');
    const collectionHandle = document.getElementById('collection-handle')?.value;
    const setsPricing = {{ sets_pricing | json }};

    // Initialize data structures
    let heightObj = {};
    let heightColorObj = {};
    let productMap = {};
    let availableHeights = new Set();
    let heightPricing = {};

    // Debug: Log collection handle
    console.log('Collection Handle:', collectionHandle);

    // Fetch collection products
    async function fetchCollectionProducts() {
      if (!collectionHandle) {
        console.error('No collection handle found');
        return { products: [] };
      }
      try {
        const response = await fetch(`/collections/${collectionHandle}/products.json?limit=250`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
      } catch (error) {
        console.error('Error fetching products:', error);
        return { products: [] };
      }
    }

    fetchCollectionProducts().then(data => {
      const products = data.products;
      console.log('Fetched Products:', products);

      if (products.length === 0) {
        console.warn('No products found in collection:', collectionHandle);
      }

      // Extract unique heights, colors, and prices
      products.forEach(product => {
        // Extract character from product title
        const titleParts = product.title.split(' - ');
        const character = titleParts[titleParts.length - 1].trim();
        const charId = character.toLowerCase().replace(/[^a-z0-9]/g, '');
        productMap[charId] = product;

        product.variants.forEach(variant => {
          const height = variant.option1;
          const color = variant.option2;
          const price = variant.price / 100; // Convert cents to dollars
          const heightColor = `${height}||${color}`;
          const letterId = `letter-${charId}`;

          // Populate heightObj
          if (!heightObj[height]) {
            heightObj[height] = new Set();
          }
          heightObj[height].add(color);
          availableHeights.add(height);

          // Store pricing (use lowest price for each height)
          if (!heightPricing[height] || price < heightPricing[height].price) {
            heightPricing[height] = {
              price: price,
              note: height.includes('12"') ? 'Made to order, 15-piece minimum, non-returnable, non-refundable, unable to expedite' : ''
            };
          }

          // Populate heightColorObj
          if (!heightColorObj[heightColor]) {
            heightColorObj[heightColor] = new Set();
          }
          heightColorObj[heightColor].add(letterId);
        });
      });

      console.log('Height Object:', heightObj);
      console.log('Height Pricing:', heightPricing);

      // Populate size selector dynamically
      sizeSelector.innerHTML = '<option value="" disabled selected>Select Size</option>';
      Array.from(availableHeights).sort().forEach(height => {
        const pricing = heightPricing[height];
        const option = document.createElement('option');
        option.value = height;
        option.dataset.price = pricing.price;
        option.dataset.note = pricing.note || '';
        option.textContent = `${height} - $${pricing.price.toFixed(2)} ea.`;
        sizeSelector.appendChild(option);
      });

      // Populate pricing table dynamically
      const pricingTableBody = document.getElementById('pricing-table-body');
      Array.from(availableHeights).sort().forEach(height => {
        const pricing = heightPricing[height];
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${height}</td>
          <td>$${pricing.price.toFixed(2)} ea.</td>
          <td>${pricing.note || ''}</td>
        `;
        pricingTableBody.appendChild(row);
      });

      // Populate sets pricing table dynamically
      const setsPricingTableBody = document.getElementById('sets-pricing-table-body');
      if (setsPricingTableBody) {
        Array.from(availableHeights).sort().forEach(height => {
          const setPricing = setsPricing[height];
          if (setPricing) {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${height}</td>
              <td>$${setPricing['250pc'].original.toFixed(2)} Now $${setPricing['250pc'].discounted.toFixed(2)}</td>
              <td>$${setPricing['100pc'].original.toFixed(2)} Now $${setPricing['100pc'].discounted.toFixed(2)}</td>
              <td>$${setPricing['40pc_number'].original.toFixed(2)} Now $${setPricing['40pc_number'].discounted.toFixed(2)}</td>
              <td>$${setPricing['20pc_punct'].original.toFixed(2)} Now $${setPricing['20pc_punct'].discounted.toFixed(2)}</td>
            `;
            setsPricingTableBody.appendChild(row);
          }
        });
      }

      // Update color selector based on height
      sizeSelector.addEventListener('change', () => {
        const selectedHeight = sizeSelector.value;
        colorSelector.innerHTML = '<option value="" disabled selected>Select Color</option>';
        if (heightObj[selectedHeight]) {
          Array.from(heightObj[selectedHeight]).sort().forEach(color => {
            const option = document.createElement('option');
            option.value = color;
            option.textContent = color;
            colorSelector.appendChild(option);
          });
        }
        updateAvailableCharacters();
      });

      // Update available characters based on height and color
      colorSelector.addEventListener('change', updateAvailableCharacters);

      function updateAvailableCharacters() {
        const selectedHeight = sizeSelector.value;
        const selectedColor = colorSelector.value;
        const heightColor = `${selectedHeight}||${selectedColor}`;
        const letters = document.querySelectorAll('.letters .letter');

        letters.forEach(letter => {
          const letterId = letter.querySelector('input').id;
          if (selectedHeight && selectedColor && heightColorObj[heightColor]?.has(letterId)) {
            letter.classList.add('active');
            letter.querySelector('input').value = 0;
          } else {
            letter.classList.remove('active');
            letter.querySelector('input').value = 0;
          }
        });

        updatePrice();
      }

      // Update price dynamically
      function updatePrice() {
        const selectedHeight = sizeSelector.value;
        const pricePerUnit = sizeSelector.selectedOptions[0]?.dataset.price || 0;
        const quantities = Array.from(form.querySelectorAll('input[type="number"]'))
          .reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
        const totalPrice = (quantities * pricePerUnit).toFixed(2);
        priceDisplay.textContent = `$${totalPrice}`;
      }

      // Update price on quantity change
      form.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', updatePrice);
      });
    });

    // Form Submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const size = sizeSelector.value;
      const color = colorSelector.value;
      const note = sizeSelector.selectedOptions[0]?.dataset.note || '';
      const quantities = Array.from(form.querySelectorAll('input[type="number"]'))
        .filter(input => parseInt(input.value) > 0)
        .map(input => ({
          character: input.name.match(/Character: (.+)]/)[1],
          quantity: parseInt(input.value)
        }));

      if (!size) {
        alert('Please select a letter/panel height.');
        return;
      }
      if (!color) {
        colorError.classList.remove('hidden');
        return;
      } else {
        colorError.classList.add('hidden');
      }
      if (quantities.length === 0) {
        charsError.classList.remove('hidden');
        return;
      } else {
        charsError.classList.add('hidden');
      }
      if (note.includes('15-piece minimum') && quantities.reduce((sum, item) => sum + item.quantity, 0) < 15) {
        minimumError.classList.remove('hidden');
        return;
      } else {
        minimumError.classList.add('hidden');
      }

      for (const item of quantities) {
        const variantId = await findVariantId(item.character, size, color);
        if (variantId) {
          await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: variantId,
              quantity: item.quantity,
              properties: { Character: item.character, Height: size, Color: color }
            })
          });
        }
      }

      window.location.href = '/cart';
    });

    async function findVariantId(character, size, color) {
      const charId = character.toLowerCase().replace(/[^a-z0-9]/g, '');
      const product = productMap[charId];
      if (!product) {
        console.error('Product not found for character:', character);
        return null;
      }

      try {
        const response = await fetch(`/products/${product.handle}.json`);
        const productData = await response.json();
        const variant = productData.product.variants.find(v => 
          v.option1 === size && 
          v.option2 === color
        );
        return variant?.id;
      } catch (error) {
        console.error('Error fetching variant:', error);
        return null;
      }
    }
  });
</script>