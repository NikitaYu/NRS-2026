{% comment %}
  This section creates a bulk order form for a PAGE.
  - Final Version: This version has the correct schema with the collection picker.
  - Uses a robust JSON script tag to prevent JS errors.
  - Waits for the page to load to prevent theme editor conflicts.
{% endcomment %}

{%- liquid
  # This section is now controlled by a setting in the theme customizer.
  assign main_collection = section.settings.main_collection

  # --- Product option names ---
  assign option_for_size = 'Height'
  assign option_for_color = 'Color'

  assign temp_sizes = ''
  assign temp_colors = ''
  assign has_at_least_one_variant = false
-%}

<div class="page-width" data-section-id="{{ section.id }}">
  <div id="bulk-order-root-{{ section.id }}">
    <!-- The product data is now stored in a script tag to prevent syntax errors -->
    <script type="application/json" data-variants-for-section>
      {%- liquid
        echo '['
        if main_collection.products.size > 0
          for product in main_collection.products limit: 150
            assign size_option_index = ''
            assign color_option_index = ''
            for option in product.options_with_values
              if option.name == option_for_size
                assign size_option_index = 'option' | append: option.position
              endif
              if option.name == option_for_color
                assign color_option_index = 'option' | append: option.position
              endif
            endfor

            for variant in product.variants
              assign size_val = variant[size_option_index]
              assign color_val = variant[color_option_index]

              if size_val and color_val
                if has_at_least_one_variant == true
                  echo ','
                endif

                assign character = product.title | split: ' - ' | last
                if character == blank or character == product.title
                    assign character = product.title
                endif

                echo '{'
                echo '"id": ' | append: variant.id | append: ','
                echo '"character": ' | append: character | json | append: ','
                echo '"price_raw": ' | append: variant.price | append: ','
                echo '"price": ' | append: variant.price | money | json | append: ','
                echo '"size": ' | append: size_val | json | append: ','
                echo '"color": ' | append: color_val | json
                echo '}'
                
                assign has_at_least_one_variant = true

                unless temp_sizes contains size_val
                  assign temp_sizes = temp_sizes | append: '|' | append: size_val
                endunless
                unless temp_colors contains color_val
                  assign temp_colors = temp_colors | append: '|' | append: color_val
                endunless
              endif
            endfor
          endfor
        endif
        echo ']'
      -%}
    </script>

    {%- assign all_sizes = temp_sizes | remove_first: '|' | split: '|' | uniq | sort -%}
    {%- assign all_colors = temp_colors | remove_first: '|' | split: '|' | uniq | sort -%}
    
    <div class="section-header text-center">
      <h1>{{ section.settings.title | default: "Bulk Order Form" | escape }}</h1>
      {% if section.settings.description != blank %}
        <div class="rte">
          {{ section.settings.description }}
        </div>
      {% endif %}
    </div>

    {% if has_at_least_one_variant %}
      <div class="bulk-order-controls">
        <div class="bulk-order-step">
          <span class="step-number">1</span>
          <label for="size_filter_select" class="step-label">Choose Your {{ option_for_size }}</label>
          <select name="size_filter" id="size_filter_select">
            {% for size in all_sizes %}
              <option value="{{ size | escape }}">{{ size | escape }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="bulk-order-step">
          <span class="step-number">2</span>
          <label for="color_filter_select" class="step-label">Choose Your {{ option_for_color }}</label>
          <select name="color_filter" id="color_filter_select">
            {% for color in all_colors %}
              <option value="{{ color | escape }}">{{ color | escape }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <form class="bulk-order-form">
        <div class="bulk-order-step">
          <span class="step-number">3</span>
          <p class="step-label">Choose Your Letters and Quantity</p>
        </div>
        <div class="character-grid-container">
          <!-- Character grid will be rendered here by JavaScript -->
        </div>
        <div class="bulk-order-actions">
           <div class="price-display">
             <span>Total:</span>
             <span class="total-price-value">{{ 0 | money }}</span>
           </div>
           <button type="submit" class="btn button bulk-add-to-cart-btn">
            <span class="btn__text">Add Selected to Cart</span>
            <span class="btn__loader" style="display: none;">
                <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-spinner" viewBox="0 0 20 20" style="width: 20px; height: 20px; animation: 2s linear infinite spinner;"><path d="M7.229 1.173a9.25 9.25 0 1 0 11.655 11.422 1 1 0 0 0-1.785-.902 7.25 7.25 0 1 1-9.244-9.244 1 1 0 0 0 .374-1.276Z" fill="currentColor"></path></svg>
            </span>
          </button>
           <p class="bulk-order-message" style="display: none;"></p>
        </div>
      </form>
    {% else %}
      <p class="text-center">Please select a collection in the theme settings that contains products with both '{{ option_for_size }}' and '{{ option_for_color }}' options.</p>
    {% endif %}
  </div>
</div>

{% stylesheet %}
  .bulk-order-controls {
    max-width: 600px;
    margin: 0 auto 40px auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .bulk-order-step {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .step-number {
    flex-shrink: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #333;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  .step-label {
    font-weight: bold;
    font-size: 1.1em;
    margin: 0;
  }
  .bulk-order-controls select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #fff;
  }
  .bulk-order-form { max-width: 800px; margin: 0 auto; }
  .character-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 15px;
    margin-top: 20px;
    padding: 20px;
    border: 1px solid #eee;
    border-radius: 4px;
    min-height: 100px;
  }
  .character-item {
    text-align: center;
  }
  .character-item .char-label {
    font-size: 1.5em;
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
    min-height: 1.5em;
  }
  .character-item .char-input {
    width: 100%;
    text-align: center;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .character-item .char-input:disabled {
    background-color: #f5f5f5;
    cursor: not-allowed;
  }
  .bulk-order-actions { 
    display: flex; 
    justify-content: flex-end; 
    align-items: center; 
    gap: 20px; 
    margin-top: 20px; 
    flex-wrap: wrap;
  }
  .price-display {
    font-size: 1.2em;
    font-weight: bold;
  }
  .bulk-order-message {
    width: 100%;
    text-align: right;
    color: red;
  }
{% endstylesheet %}

{% javascript %}
window.addEventListener('load', function() {
  setTimeout(function() {
    try {
      const sectionId = '{{ section.id }}';
      const bulkOrderRoot = document.getElementById(`bulk-order-root-${sectionId}`);
      if (!bulkOrderRoot) return;

      const dataEl = bulkOrderRoot.querySelector('[data-variants-for-section]');
      if (!dataEl) return;

      const allVariants = JSON.parse(dataEl.textContent);
      const gridContainer = bulkOrderRoot.querySelector('.character-grid-container');
      const form = bulkOrderRoot.querySelector('.bulk-order-form');
      const submitButton = form.querySelector('.bulk-add-to-cart-btn');
      const messageEl = form.querySelector('.bulk-order-message');
      const totalPriceEl = form.querySelector('.total-price-value');
      const currency = {{ cart.currency.symbol | json }};

      const allCharacters = [...new Set(allVariants.map(v => v.character))].sort((a, b) => {
        const isANum = !isNaN(a);
        const isBNum = !isNaN(b);
        if (isANum && !isBNum) return 1;
        if (!isANum && isBNum) return -1;
        return a.localeCompare(b, undefined, { numeric: true });
      });

      function updatePrice() {
        let total = 0;
        const inputs = gridContainer.querySelectorAll('.char-input');
        inputs.forEach(input => {
          const qty = parseInt(input.value, 10);
          if (qty > 0) {
            const price = parseInt(input.dataset.priceRaw, 10);
            total += qty * price;
          }
        });
        totalPriceEl.textContent = `${currency}${(total / 100).toFixed(2)}`;
      }

      function renderCharacterGrid() {
        const selectedSize = bulkOrderRoot.querySelector('[name="size_filter"]').value;
        const selectedColor = bulkOrderRoot.querySelector('[name="color_filter"]').value;

        const availableVariants = allVariants.filter(v => v.size === selectedSize && v.color === selectedColor);

        gridContainer.innerHTML = '';

        if (availableVariants.length === 0) {
          gridContainer.innerHTML = '<p class="text-center">No products match the selected options.</p>';
        }

        allCharacters.forEach(char => {
          const item = document.createElement('div');
          item.className = 'character-item';
          
          const variant = availableVariants.find(v => v.character === char);
          const isAvailable = !!variant;

          item.innerHTML = `
            <label for="char-input-${char.replace(/[^a-zA-Z0-9]/g, "")}" class="char-label">${char}</label>
            <input 
              type="number" 
              class="char-input"
              id="char-input-${char.replace(/[^a-zA-Z0-9]/g, "")}"
              name="quantity" 
              min="0" 
              value="0" 
              ${isAvailable ? `data-variant-id="${variant.id}" data-price-raw="${variant.price_raw}"` : 'disabled'}
            >
          `;
          gridContainer.appendChild(item);
        });
        updatePrice();
      }

      function handleFormSubmit(event) {
        event.preventDefault();
        const items = [];
        const inputs = form.querySelectorAll('.char-input:not(:disabled)');
        
        inputs.forEach(input => {
          const quantity = parseInt(input.value, 10);
          if (quantity > 0) {
            items.push({
              id: input.dataset.variantId,
              quantity: quantity
            });
          }
        });

        if (items.length === 0) {
          messageEl.textContent = 'Please select a quantity for at least one item.';
          messageEl.style.display = 'block';
          return;
        }

        messageEl.style.display = 'none';
        submitButton.disabled = true;
        submitButton.classList.add('loading');

        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: items })
        })
        .then(response => response.json())
        .then(cart => {
          if (cart.status >= 400) { throw new Error(cart.description || 'An error occurred.'); }
          messageEl.textContent = 'Items added to cart!';
          messageEl.style.color = 'green';
          messageEl.style.display = 'block';
          
          if (typeof theme !== 'undefined' && typeof theme.pubsub !== 'undefined') {
            theme.pubsub.publish('cart:updated', { cart: cart });
          } else {
             document.documentElement.dispatchEvent(new CustomEvent('cart:updated', { bubbles: true, detail: { cart } }));
          }
          setTimeout(() => { messageEl.style.display = 'none'; }, 4000);
        })
        .catch(error => {
          console.error('Error:', error);
          messageEl.textContent = error.message;
          messageEl.style.color = 'red';
          messageEl.style.display = 'block';
        })
        .finally(() => {
          submitButton.disabled = false;
          submitButton.classList.remove('loading');
        });
      }

      bulkOrderRoot.addEventListener('change', (event) => {
        if (event.target.matches('[name="size_filter"], [name="color_filter"]')) {
          renderCharacterGrid();
        }
      });

      gridContainer.addEventListener('input', (event) => {
        if (event.target.matches('.char-input')) {
          updatePrice();
        }
      });
      
      form.addEventListener('submit', handleFormSubmit);

      renderCharacterGrid();
    } catch (e) {
      console.error("A fatal error occurred in the bulk order script:", e);
    }
  }, 200);
});
{% endjavascript %}

{% schema %}
{
  "name": "Custom Bulk Order Form",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Bulk Order Form"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "default": "<p>Select a size and color, then enter the quantity for each character you need.</p>"
    },
    {
      "type": "collection",
      "id": "main_collection",
      "label": "Source Collection",
      "info": "Select the collection that contains all of your individual letter products."
    }
  ],
  "presets": [
    {
      "name": "Custom Bulk Order Form"
    }
  ]
}
{% endschema %}
